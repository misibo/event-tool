{% macro render_field_errors(field) %}
{% if field.errors %}
<div class="uk-alert-danger" uk-alert>
    <a class="uk-alert-close" uk-close></a>
    {%- for error in field.errors %}
    <p>{{ error }}</p>
    {%- endfor %}
</div>
{% endif %}
{% endmacro %}

{% macro render_field(field) %}
<div class="uk-margin">
    {{ field.label(class_='uk-form-label') }}
    <div class="uk-form-controls">
        {{ field(**kwargs) | safe }}
        {{ render_field_errors(field) }}
    </div>
</div>
{% endmacro %}

{% macro render_file_field(field) %}
<div class="uk-margin">
    <div class="uk-inline uk-width-1-1" uk-form-custom="target: true">
        {{ field(**kwargs) | safe }}
        <input class="uk-input" type="text" placeholder="Datei auswählen" disabled>
        <span class="uk-form-icon uk-form-icon-flip" href="#" uk-icon="icon: folder"></span>
    </div>
</div>
{% endmacro %}

{% macro render_pdf_field(field, url) %}
<div class="uk-margin">
    {{ field.label(class_='uk-form-label') }}
    <div class="uk-form-controls">
        {% if url %}
        <span uk-icon="icon: file-pdf"></span><a class="uk-button uk-button-text uk-margin-small-left" href="{{ url }}" target="_blank">Öffnen</a>
        {% endif %}
        {{ render_file_field(field, accept="application/pdf", **kwargs) }}
        {{ render_field_errors(field) }}
    </div>
</div>
{% endmacro %}

{% macro render_image_field(field, url) %}
<div class="uk-margin">
    {{ field.label(class_='uk-form-label') }}
    <div class="uk-form-controls">
        {% if url %}
        <div data-src="{{ url }}" uk-img
            class="uk-flex uk-flex-middle uk-flex-center uk-height-medium uk-placeholder uk-background-contain">
        </div>
        {% endif %}
        {{ render_file_field(field, **kwargs) }}
        {{ render_field_errors(field) }}
    </div>
</div>
{% endmacro %}

{% macro render_pagination(pagination, endpoint, params={}, position='center') %}
{% if pagination.pages > 1 %}
<ul class="uk-pagination uk-flex-{{position}}">
    {% if pagination.has_prev %}
    <li><a href="{{ url_for(endpoint, **merge_into(params, page=pagination.prev_num)) }}"><span uk-pagination-previous></span></a>
    </li>
    {% endif %}
    {%- for page in pagination.iter_pages() %}
    {% if page %}
    {% if page != pagination.page %}
    <li><a href="{{ url_for(endpoint, **merge_into(params, page=page)) }}">{{ page }}</a></li>
    {% else %}
    <li class="uk-active"><span>{{ page }}</span></li>
    {% endif %}
    {% else %}
    <li class="uk-disabled"><span>...</span></li>
    {% endif %}
    {%- endfor %}
    {% if pagination.has_next %}
    <li><a href="{{ url_for(endpoint, **merge_into(params, page=pagination.next_num)) }}"><span uk-pagination-next></span></a></li>
    {% endif %}
</ul>
{% endif %}
{% endmacro %}

{% macro render_order(label, name, args, form='') %}
<div uk-form-custom>
    {% with selected = args['order.'+name] %}
    <select name="order.{{ name }}" onchange="this.form.submit()" {% if form %}form="{{form}}"{% endif %}>
        <option {% if not selected %}selected{% endif %} value="">Entfernen</option>
        <option {% if selected == 'asc' %}selected{% endif %} value="asc">Aufsteigend</option>
        <option {% if selected == 'desc' %}selected{% endif %} value="desc">Absteigend</option>
    </select>
    <div>
        {{ label }}
        {% if selected == 'asc' %}
        <span uk-icon="icon: arrow-up"></span>
        {% elif selected == 'desc' %}
        <span uk-icon="icon: arrow-down"></span>
        {% else %}
        <span uk-icon="icon: pencil"></span>
        {% endif %}
    </div>
    {% endwith %}
</div>
{% endmacro %}

{% macro render_filter(label, name, choices, args, form='') %}
<div uk-form-custom>
    {% with selected = args['filter.'+name] %}
    <select name="filter.{{ name }}" onchange="this.form.submit()" {% if form %}form="{{form}}"{% endif %}>
        <option {% if not selected %}selected{% endif %} value="">Entfernen</option>
        {% for val, label in choices.items() %}
        <option value="{{ val }}" {% if val == selected %}selected=""{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    <div>
        {{ label }}
        {% if selected %}
        :{{choices[selected]}}
        {% else %}
        <span uk-icon="icon: settings"></span>
        {% endif %}
    </div>
    {% endwith %}
</div>
{% endmacro %}

{% macro render_search(args) %}
<div class="uk-search uk-search-default uk-width-medium">
    <button uk-search-icon></button>
    <input class="uk-search-input" type="search" placeholder="Search ..." name="search" {% if args['search'] %}
        value="{{ args['search'] }}" {% endif %}>
</div>
{% endmacro %}

{% macro render_menu_item(name, endpoint, active_class='uk-active', li_cls='', a_cls='') %}
<li {% if url_for(endpoint) == request.path %} class="{{ active_class }}" {% endif %} {% if li_cls %} class="{{ li_cls }}" {% endif %}>
    <a {% if a_cls %} class="{{ a_cls }}" {% endif %} href="{{ url_for(endpoint) }}">{{ name }}</a>
</li>
{% endmacro %}

{% macro _render_rich_text_element(parts) %}
{% for t in parts %}
    {% if t.type == 'text' %}
        {% if t.mode == 'normal' %}
            {{t.text}}
        {% elif t.mode == 'bold' %}
            <strong>{{t.text}}</strong>
        {% elif t.mode == 'italic' %}
            <em>{{t.text}}</em>
        {% elif t.mode == 'monospace' %}
            <kbd>{{t.text}}</kbd>
        {% endif %}
    {% elif t.type == 'link' %}
        <a href="{{t.url}}">{{_render_rich_text_element(t.richtext)}}</a>
    {% endif %}
{% endfor %}
{% endmacro %}

{% macro text2html(text) %}
    {% for p in text|parse_freeform %}
        {% if p.type == 'simple' %}
            <p>
                {{_render_rich_text_element(p.parts)}}
            </p>
        {% elif p.type == 'list' %}
            <ul class="uk-list uk-list-striped">
                {% for item in p.items %}
                    <li>
                        {{_render_rich_text_element(item.parts)}}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endfor %}
{% endmacro %}

{% macro render_group_logo(group, resolution=32) %}
    {% if group.logo_version %}
    <img data-src="{{ group.get_logo_url(resolution=resolution) }}" uk-img>
    {% else %}
    <div class="uk-placeholder uk-margin-remove uk-padding-remove uk-flex uk-flex-center uk-flex-middle" style="height:{{ resolution }}px; width:{{ resolution }}px;">
        <div class="{% if resolution > 48 %}uk-text-large{% endif %} uk-text-bold uk-text-uppercase">{{ group.name[0:2] }}</div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_user_avatar(user, resolution=64, class='') %}
    {% if user.avatar_version %}
    <img class="{{ class }}" data-src="{{ url_for('static', filename='user/%d/avatar_%dx%d.png'% (user.id, resolution, resolution)) }}">
    {% else %}
    <div class="uk-placeholder uk-margin-remove uk-padding-remove uk-flex uk-flex-center uk-flex-middle {{ class }}" style="height:{{ resolution }}px; width:{{ resolution }}px;">
        <div class="{% if resolution > 48 %}uk-text-large{% endif %} uk-text-bold uk-text-uppercase">{{ user.first_name[0] }}{{ user.family_name[0] }}</div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_event_date(event, width=64, height=false) %}
{% if not height %}{% set height = width %}{% endif %}
<div class="uk-placeholder uk-margin-remove uk-padding-remove uk-flex uk-flex-center uk-flex-middle uk-flex-column" style="height: {{height}}px; width: {{width}}px;">
    <div class="uk-text-large uk-text-bold">{{ event.start.strftime('%d') }}</div>
    <div>{{ event.start.strftime('%b') }}</div>
</div>
{% endmacro %}
